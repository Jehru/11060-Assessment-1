<!DOCTYPE html>
<html>
<head>

    <!-- Basic Stuff template stuff -->
    <!-- This is actually Necessary for the framework to work in mobile contexts -->
    <meta charset="utf-8">
    <title>Frogs of Australia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- CSS -->
    <!-- UIKit Framework -->
    <!-- UIkit CSS CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.6.18/dist/css/uikit.min.css" />


    <!-- SCRIPTS -->
    <!-- UIkit JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.6.18/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.6.18/dist/js/uikit-icons.min.js"></script>

    <!-- jQuery JS CDN-->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous">
    </script>


    <!-- My Custom Styling -->
    <style>

        /* Poppins font sourcing */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600;700&display=swap');

        /* Colour scheme
        https://coolors.co/d8f3dc-95d5b2-52b788-2d6a4f-081c15
            #d8f3dc
            #95d5b2
            #52b788
            #2D6A4F
            #081C15
         */

        /* Sets San serif font for whole page. Serifs are Yuk */
        /* Poppins is a cute rounded font that fits the frogs */
        body {
        font-family: "Poppins", sans-serif;
        font-size: 17px; 
        background-color: #d8f3dc;
        color: #081C15;
        }

        /* Top of page */
        /* Includes heading and buttons aka, everything that is static */
            /* padding: top right bottom left */
        #top{
            text-align: center;
            padding: 100px 0 70px 0;

        }

        /* Sets the size and weight for the heading copy */
        h1 {
            font-size: 70px;
            font-weight: 700;
            margin-top: 0px;
        }

        /* Sets the font size for the body text */
        p {
            font-size: 16px;
        }

        /* Sets custom letter spacing for the "frogs of" part of the heading  */
        /* Done to line up with the "Australia" heading copy */
        .heading1 h1{
            letter-spacing: 4px;
            display: inline;
        }

        /* The emphasis text, "of" in the heading */
        /* Sets a different colour and slightly smaller size  */
        .heading1 em{
            font-size: 50px;
            font-weight: 700;
            color: #E0607E;
        }

        /* Sets the "show frogs near me" button styling */
        /* The button styling and text */
        #find-me{
            letter-spacing: 2px;
            padding: 25px 55px;
            text-transform: uppercase;
            cursor: pointer;
            margin: 15px 30px;
            background-color: #95d5b2;
            border-radius: 7px;
        }

        /* Adds an hover effect to the button slightly darker green with 0.4s delay  */
        #find-me:hover{
            background-color: #2D6A4F;
            -webkit-transition: all 0.4s;
            -moz-transition: all 0.4s;
            transition: all 0.4s;
        }

        /* So the audio controls bar so that it doesnt go over the div card on smaller displays */
        audio {
            width: 100%;
        }

    </style>
</head>
<body>

<!-- My Main Script -->
<script>

    // When DOM and page is ready 
    $(document).ready(function() {

        // The main function in the code 
        // Runs when the user clicks the "Show frogs near me" button
        function geoFindMe() {

            // Api Call 
            // const spatialUrl = "https://biocache-ws.ala.org.au/ws/occurrences/search.json*?q=frog&pageSize=150&im=false ";
            // console.log("Here");
            // console.log(spatialUrl);

            // 
            // 
            // 
            const status = document.querySelector('#status');
            const mapLink = document.querySelector('#map-link');

            // If the user successfully allows their location
            function success(position) {
                // Get users current latitude and longitude
                // Create constants for those variables 
                const latitude  = position.coords.latitude;
                const longitude = position.coords.longitude;
        
                // 
                // 
                // 
                status.textContent = ''; 

                // Google Cloud development Key and Reverse Geolocation Api 
                // This will allow us to get the users current location in street name and address
                const gDevApiKey = "AIzaSyBXbTrT4c4Fw_n7gAzh1UQ3PrUO8yEyjmQ";
                const gDevMapUrl = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + latitude + "," + longitude +"&key=" + gDevApiKey;
                // console.log(gDevMapUrl);   

                // Get the json data from the Google development Url, which will give us the name of the address of the user 
                $.getJSON(gDevMapUrl, function(addressData) {
                    // console.log(addressData);

                    // Create a variable for the users current address as formatted (streetname, suburb state postcode, country)
                    let locatedAddress = addressData.results[0].formatted_address;

                    // Update the map link class so that it appends the address to the page.
                    $('#map-link').append("<h3> You are located at " + locatedAddress + "</h3>")


                    // Finding the nearby frogs in the users current location within a 5km radius
                    const locationUrl = "https://biocache-ws.ala.org.au/ws/explore/group/Amphibians.json?lat=" + latitude + "&lon=" + longitude + "&radius=5&start=0&pageSize=200"
                    // console.log(locationUrl);

                    // Get the json data from the above url which shows the frogs within 5km of the user
                    $.getJSON(locationUrl, function(locationData){
                        // console.log(locationData);

                        // For each frog that appears within 5km
                        for(let i = 0; i <locationData.length; i++) {
                        
                            // Create a constant for the frogs common name
                            const frogName = locationData[i].commonName 

                            // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURI
                            // Query an api that includes information about each specific frog 
                            // Encode this url to reduce any spaces and any other characters to be url friendly and remove any whitespace if it exists
                            const frogUrl = encodeURI("https://bie.ala.org.au/ws/search.json?q=" + frogName + "&pageSize=5".trim())
                            // console.log(frogUrl);

                                // Query that specific url for each frog to get the json data
                                // This will provide  information about each of the species nearby
                                // Such as the frogs name and who found it
                                $.getJSON(frogUrl, function(speciesData){
                                    // console.log(speciesData);

                                    // Create a constant for the img url of the frogs
                                    const imgSrc = speciesData.searchResults.results[0].imageUrl

                                    // Create a constant to make indexing the information easier
                                    const speciesInfo = speciesData.searchResults
                                                
                                    // Removes the default items if they are present
                                    $('#ifNoItems').remove();

                                    // Cerate a constant for the species name that includes an underscore instead of a space
                                    const linkId = speciesData.searchResults.results[0].linkIdentifier

                                    // Url that links to the amphibiaweb sound files. These are hosted on the web and are audiofiles
                                    var soundFileUrl= "https://amphibiaweb.org/sounds/" + linkId + ".wav"
                                    // console.log(soundFileUrl);

                                    // Main append
                                    // Appends each frog item to the page includes the name, amount of frogs near the user
                                    // There is hidden information that is shown when the user clicks on the card
                                    $('.uk-grid-medium').append('<div><div class = "uk-card uk-card-default uk-card-body"> <b>' 
                                    + locationData[i].commonName + '</b><br><p>' +  
                                    '<br>' + 'There are ' + locationData[i].count +' found near you</p> <img src="'+ imgSrc 
                                    +'"> <p class="hiddenText" style="display: none"> Author: '+ speciesInfo.results[0].author + '<br>' +
                                    'Genus: ' + speciesInfo.results[0].genus + '<br>' + 'Name: '+ speciesInfo.results[0].name  +
                                    '<br> Class: '+ speciesInfo.results[0].class +'</p>' +
                                    '<div class="audio" style="display:none"><audio controls source src="' + soundFileUrl + '" ></audio></div></div></div>' );
                                
                                    // When no image is found (on an error) then use a broken image image instead of the frog image
                                    // https://stackoverflow.com/questions/56166094/update-img-src-if-image-does-not-exist
                                    $('.uk-grid-medium img').on('error', function() {
                                        this.src = 'https://piotrkowalski.pw/assets/camaleon_cms/image-not-found-4a963b95bf081c3ea02923dceaeb3f8085e1a654fc54840aac61a57a60903fef.png';
                                        });
                                    
                                    // -----------
                                    // TESTING Frog audio on error
                                    // ----------- 
                                    $("#audio audio").on("error", function(e) {
                                        console.log("audio not found");
                                        alert("Error at audio tag level!");
                                    });

                                });
                                
                        }

                    });

                    
                });

            }

            // If an error occurs such as user clicks 'block' for their location then provide a message
            function error() {
                status.textContent = 'Unable to retrieve your location';
            }

            // If navigator is not found then tell the user its not supported
            // Otherwise use navigator to try and get the location of the user
            // If its allowed then run success. If its blocked then run the error
            if(!navigator.geolocation) {
                status.textContent = 'Navigator geolocation is not supported by your browser, to use this feature try it on Google Chrome';
            } else {
                status.textContent = 'Locating…';
                navigator.geolocation.getCurrentPosition(success, error);
            }

        }

        // Default Action
        // This is what happens when the page loads the site provides 3 default frogs
        // These are limited in function and information as they are meant to be a 'sample'
        function defaultAction() {
            // Use a api query that is limited to 3 results
            defaultUrl = "https://bie.ala.org.au/ws/search.json?q=frog&pageSize=3"

            // Get the json data from querying that url above
            $.getJSON(defaultUrl, function(data){
                // console.log(data.searchResults.results);

                // Create a constant that makes indexing the information easer
                const defaultFrog = data.searchResults.results;
                console.log(defaultFrog);

                // Create a loop for each of the default loaded frogs
                for(let i = 0; i < defaultFrog.length; i++) {
                    // Append each of these frogs to the webpage
                    // include the name, image and hide the common name 
                    $('#ifNoItems').append('<div><div class = "uk-card uk-card-default uk-card-body"><b>' + defaultFrog[i].name + '</b>' + '<img src="' + defaultFrog[i].imageUrl 
                        + '"> <p class="hiddenText" style="display: none"> Common Name: '+ defaultFrog[i].commonNameSingle + '</p></div></div>' )
                }
            })
        }

        // Run the default action
        defaultAction();

        // When the user clicks on the "show frogs near me" button run the geoFindMe function
        $('#find-me').click(geoFindMe);

        // When user clicks on the class 'uk card' in the body find the hiddenText and audio class and show/hide them
        // https://stackoverflow.com/questions/29372003/click-event-is-not-working-when-data-loads-dynamic-in-jquery
        $('body').on('click','.uk-card' ,function(){
            $(this).find(".hiddenText").toggle();        
            $(this).find(".audio").toggle();

        });

    });
</script>

    <!-- Create a div called top, this is always shown regardless if the default or located frogs are shown -->
    <div id = "top">
        <!-- Split up the title so that words can appear on top of each other -->
        <!-- Give the 'of' text emphasis (This results in a different colour and size) -->
        <div class ="heading1">
            <h1>Frogs</h1> 
            <em>of</em>
        </div> 
        <h1>Australia</h1>

        <!-- Create a button that shows frogs near the user  -->
        <button id = "find-me">Show frogs near me</button><br/>
            <!-- If clicked status provides the user with a 'locating ' -->
            <p id = "status"></p>
            <!-- If clicked map-link shows where the user is currently located -->
            <div id = "map-link"></div>

            <!-- <div id = "frogLocated"></div> -->
    </div>

    <!-- This div showcases the located data (when the user clicks on 'frogs near me') -->
    <div class = "uk-grid-medium uk-grid-match uk-child-width-1-3@m uk-text-left uk-padding" uk-grid></div>

    <!-- The default frogs that show if the user hasnt clicked the  -->
    <div id = "ifNoItems" class = "uk-grid-small uk-grid-match uk-child-width-1-3@m uk-text-left uk-padding" uk-grid></div>
       
</body>
</html>
