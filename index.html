<!DOCTYPE html>
<html>
<head>
    <style>
        /* Custom Styles here */

        /* Sets Sanserif font for whole page. Serifs are Yuk */
        body {
        font-family: "Roboto", sans-serif;
        font-size: 17px; 
        }

        /* https://stackoverflow.com/questions/52472667/how-to-display-image-in-css-grid/52473643 */
        /* CSS grid */
        #item {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-column-gap: 25px;
            grid-row-gap: 25px;
        }

        #item > div img {
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Sets the tile background colour to light grey */
        .eachItem {
            background-color: lightgrey;
        }

    </style>
</head>
<body>
    <!-- Finds CDN Scripts such as Jquery -->
    <script
        src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous">
    </script>

<!-- My Main Script -->
<script>
    $(document).ready(function() {

        // -----------------------
        // ALA WEB API
        // https://api.ala.org.au/#
        // -----------------------
        // EXAMPLES
        // https://biocache-ws.ala.org.au/ws/occurrences/search?fq=occurrence_decade_i:%222020%22&q=genus:%22Macropus%22
        // https://bie.ala.org.au/ws/search.json?q=frog
        // https://collections.ala.org.au/ws/dataResource

            // Api Key and Api URL set as constants
            // const apiKey = "&apikey=e1l09TYfUkdo9BMpfiUn5oV74IHmBcRe";
            // const query = ;

            const apiUrl = "https://bie.ala.org.au/ws/search.json?q=frog&pageSize=10"; // Should equal the search item object

            // The spatial APi is the one which also includes the data around 
            // const spatialUrl = "https://biocache-ws.ala.org.au/ws/occurrences/search.json*?q=frog&pageSize=100&im=false ";
            // Sometimes it seems bugged and it doesnt load images, More testing required as to whether the above URL conflicts with the image api
            const spatialUrl = "https://biocache-ws.ala.org.au/ws/occurrences/spatial*?q=frog&pageSize=10";
           
            
            // Read out the url to see where its getting the data from
            console.log(apiUrl);
            console.log(spatialUrl);


        // Fetch the api Url then respond with the json information 
        $.getJSON(apiUrl, function(searchResults) {

                // Console the url
                console.log(searchResults);

                // Create variables to use in the project 
                let searchObject = searchResults.searchResults;
                let queryItem = searchObject.queryTitle;
                // const firstResult = searchResults.results[0].name;
                let allResults = searchObject.results;


                // Add the collection title to the page and  add the number of results found
                // https://stackoverflow.com/questions/5122402/uppercase-first-letter-of-variable 

                $('#heading')
                .append('<h1>' + queryItem + '</h1>')
                .css('textTransform', 'capitalize')
                .append('<h2> Number of Species: ' + searchObject.totalRecords + '</h2>');

            
                // create a variable that holds all the searched results 
                let frogData = allResults;
                    console.log(allResults);


                // For each item that is searched  
                for(let i = 0; i <allResults.length; i++) {

                    // Creates a variable to see if there is an author
                    let frogAuthor = allResults[i].author;
                    // console.log(typeof frogAuthor);

                    // If the author is undefined then say no author found 
                    // Otherwise display the authors name 
                    // Better solution would be to have a variabble which changes depending on its returned vaule
                    // Eg. if (frogauthor == null ) { Authorsname = "No author found"} else {Name = name}
                    if(frogAuthor == null){
                        $('#item').append('<div class="eachItem"'+ allResults[i].id +
                        '><h3>' + allResults[i].name + '</h3>' + '<img src=' + 
                        allResults[i].smallImageUrl + ' style="width: 100%; height: 300px;"><div class="noImage"></div> <p class="hiddenText" style="display: none"> Author name: <br>' + 
                        "No Author found" +'</p></div>');
                        
                    } else {
                        $('#item').append('<div class="eachItem"'+ allResults[i].id +
                        '><h3>' + allResults[i].name + '</h3>' + '<img src=' + 
                        allResults[i].smallImageUrl + ' style="width: 100%; height: 300px;"><div class="noImage"></div> <p class="hiddenText" style="display: none"> Author name: <br>' + 
                        allResults[i].author +'</p></div>');
                    }

                    // My original way to display data
                    // Adds an image if there is one in the object. This also prints the name out. 
                    // $('#item').append('<div class="eachItem"'+ allResults[i].id +
                    // '><h3>' + allResults[i].name + '</h3>' + '<img src=' + 
                    // allResults[i].smallImageUrl + ' style="width: 100%; height: 300px;"><div class="noImage"></div> <p class="hiddenText" style="display: none"> Author name: <br>' + 
                    // allResults[i].author +'</p></div>');
                
                    // What happens when there is no image found. AKa the broken image url
                    // https://stackoverflow.com/questions/56166094/update-img-src-if-image-does-not-exist
                    $('.eachItem img').on('error', function() {
                        this.src = 'https://piotrkowalski.pw/assets/camaleon_cms/image-not-found-4a963b95bf081c3ea02923dceaeb3f8085e1a654fc54840aac61a57a60903fef.png';
                        });
                        
                    
                }

                // https://api.jquery.com/toggle/
                // https://api.jquery.com/find/

                // When the user clicks on the little tile  
                $(".eachItem").click(function() {

                    // For the item that has been clicked find the item with class hiddentext and show/hide it
                    $(this).find(".hiddenText").toggle();

                });                
            

            // Geolocation
            // https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API
            // Fix up, make it jQuery, such as on click
            function geoFindMe() {

                const status = document.querySelector('#status');
                const mapLink = document.querySelector('#map-link');

                mapLink.href = '';
                mapLink.textContent = '';

                function success(position) {

                    // Get users current lat and long 
                    const latitude  = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    // Testing with other values
                    // const latitude  = 51.5074;
                    // const longitude = 0.1278;

                    status.textContent = '';
                    mapLink.href = `https://www.openstreetmap.org/#map=18/${latitude}/${longitude}`;
                    mapLink.textContent = `Latitude: ${latitude.toFixed(2)} °, Longitude: ${longitude.toFixed(2)} °`;
                    console.log("Latitude: " + latitude);
                    console.log("Longitude: " + longitude)    

                    // Google Cloud development Key and Reverse Geolocation Api 
                    const gDevApiKey = "AIzaSyBXbTrT4c4Fw_n7gAzh1UQ3PrUO8yEyjmQ";
                    const gDevMapUrl = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + latitude + "," + longitude +"&key=" + gDevApiKey;

                    // Spit out URL for easy IDentification of data
                    console.log(gDevMapUrl);   

                    // Get the data from the Google development Url, which will give us the name of the city which currently in 
                    $.getJSON(gDevMapUrl, function(e) {
                        console.log(e.results[0].address_components[3].long_name);

                        // Create a variable for the city which the user is currently in
                        let locatedCity = e.results[0].address_components[3].long_name;
                        $('#map-link').append("<p>City: " + locatedCity + "</p>")


                        // Spatial Mapping function
                        $.getJSON(spatialUrl, function(mapResults) {
                                
                                console.log(mapResults);

                                $('#mapTotal').append('<p> Number of user uploads to map: ' + mapResults.totalRecords + '</p>');

                                let mapRecords = mapResults.occurrences;
                                let statePr = mapResults.occurrences[0].stateProvince;
                                // Number 5 is ACT and works
                                // let statePr = mapResults.occurrences[5].stateProvince;

                                    console.log(mapRecords);
                                    console.log(locatedCity);
                                    console.log(statePr);

                                    // For each item that is searched check if its in the ACT
                                    for(let i = 0; i < mapRecords.length; i++) {

                                        // New Value for located city
                                        // Australian Capital Territory
                                        let locatedCity = e.results[0].address_components[3].long_name;
                            
                                        // New value for statePr
                                        // Will change for each result in the array
                                        let statePr = mapResults.occurrences[i].stateProvince;

                                        // If the state province found equals the users located city (ACT)
                                        if(locatedCity == statePr){
                                            console.log("Yes its the same state " + mapResults.occurrences[i].vernacularName);
                                            $('#frogLocated').append("<p> Frog found: "+ mapResults.occurrences[i].vernacularName + 
                                                " <br> Collector: " + mapResults.occurrences[i].collector + "<br> In " + mapResults.occurrences[i].year +
                                                "</p>");
                                            } else {
                                                console.log("Not the same State")
                                            }
                                            
                                    }
                            });

                    });

                }
                function error() {
                    status.textContent = 'Unable to retrieve your location';
                }

                if(!navigator.geolocation) {
                    status.textContent = 'Geolocation is not supported by your browser';
                } else {
                    status.textContent = 'Locating…';
                    navigator.geolocation.getCurrentPosition(success, error);
                }

            }

            document.querySelector('#find-me').addEventListener('click', geoFindMe);

        });


        

        

    });
</script>

        <!-- Geolocation Map  -->
        <button id = "find-me">Show my location</button><br/>
        <p id = "status"></p>
        <a id = "map-link" target="_blank"></a>
        <div id = "frogLocated"></div>

        <!-- Main divs -->
        <div id="heading"></div>
        <div id="mapTotal"></div>
        <div id="map"></div>
        <div id="item"></div>

       


    </body>
</html>


<!-- OKAY SPATIAL API SUCKS -->

<!-- THESE ONES MAY BE GOOD -->
<!-- GET /occurrences/coordinates* -->
<!-- https://biocache-ws.ala.org.au/ws/occurrences/coordinates*?q=frog -->
<!-- GET /occurrences/search* -->
<!-- https://biocache-ws.ala.org.au/ws/occurrences/search*?q=frog&im=false -->
<!-- Get /occurrences/search.json* -->
<!-- https://biocache-ws.ala.org.au/ws/occurrences/search.json*?q=frog&im=false -->